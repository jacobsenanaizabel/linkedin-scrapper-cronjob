name: LinkedIn Job Scraper (RIGGeqD6RqKmlVoQU)

on:
  # Runs automaticamente a cada 3 dias Ã s 09:00 UTC (10:00 em Portugal)
  schedule:
  #  - cron: '0 9 */3 * *'
  
  # Permite executar manualmente
  workflow_dispatch:

jobs:
  scrape-linkedin-jobs:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install requests

      - name: Run LinkedIn Scraper - React Jobs
        env:
          APIFY_TOKEN: ${{ secrets.APIFY_TOKEN }}
        run: |
          python3 << 'EOF'
          import requests
          import json
          import os
          from datetime import datetime

          # ConfiguraÃ§Ã£o
          API_TOKEN = os.environ['APIFY_TOKEN']
          ACTOR_ID = "RIGGeqD6RqKmlVoQU"

          # Job Search 1: Senior Frontend Engineer - Madrid
          payload_1 = {
              "title": "Senior Frontend Engineer",
              "location": "madrid",
              "limit": 50,
              "contractType": ["F"],           # F = Full-time
              "experienceLevel": ["4"],        # 4 = Senior level
              "datePosted": "r604800"          # r604800 = Ãºltimas 7 dias
          }

          # Job Search 2: React Developer - Spain Remote
          payload_2 = {
              "title": "React Developer Remote",
              "location": "spain",
              "limit": 50,
              "contractType": ["F"],
              "experienceLevel": ["4"],
              "datePosted": "r604800"
          }

          # Job Search 3: Staff Engineer - Spain
          payload_3 = {
              "title": "Staff Engineer",
              "location": "spain",
              "limit": 50,
              "contractType": ["F"],
              "experienceLevel": ["4", "5"],   # 4 = Senior, 5 = Director/VP
              "datePosted": "r604800"
          }

          # Job Search 4: Frontend Lead - Madrid
          payload_4 = {
              "title": "Frontend Lead",
              "location": "madrid",
              "limit": 50,
              "contractType": ["F"],
              "experienceLevel": ["4", "5"],
              "datePosted": "r604800"
          }

          # Lista de todas as buscas
          searches = [
              ("Senior Frontend Engineer - Madrid", payload_1),
              ("React Developer Remote - Spain", payload_2),
              ("Staff Engineer - Spain", payload_3),
              ("Frontend Lead - Madrid", payload_4)
          ]

          url = f"https://api.apify.com/v2/acts/{ACTOR_ID}/runs"
          headers = {
              "Authorization": f"Bearer {API_TOKEN}",
              "Content-Type": "application/json"
          }

          print("=" * 60)
          print(f"ðŸš€ LINKEDIN JOB SCRAPER - Multiple Searches")
          print(f"â° Started: {datetime.now()}")
          print("=" * 60)

          all_run_ids = []

          for search_name, payload in searches:
              print(f"\nðŸ“Š Starting search: {search_name}")
              print(f"   Title: {payload['title']}")
              print(f"   Location: {payload['location']}")
              print(f"   Limit: {payload['limit']}")
              
              response = requests.post(url, json=payload, headers=headers)

              if response.status_code == 201:
                  run_id = response.json()['data']['id']
                  all_run_ids.append((search_name, run_id))
                  print(f"   âœ… Started! Run ID: {run_id}")
              else:
                  print(f"   âŒ Error: {response.status_code}")
                  print(f"   Response: {response.text}")

          print("\n" + "=" * 60)
          print("ðŸ“‹ SUMMARY")
          print("=" * 60)
          print(f"Total searches: {len(searches)}")
          print(f"Successful: {len(all_run_ids)}")
          print("\nðŸ”— Monitor your runs:")
          
          for search_name, run_id in all_run_ids:
              print(f"  â€¢ {search_name}")
              print(f"    https://console.apify.com/actors/runs/{run_id}")
          
          print("\nâ±ï¸  Expected completion: 3-5 minutes per search")
          print("ðŸ“¥ Results will be available in Apify Console")
          print("=" * 60)

          # Guardar run IDs para referÃªncia
          with open('last_runs.txt', 'w') as f:
              for search_name, run_id in all_run_ids:
                  f.write(f"{search_name}: {run_id}\n")
              f.write(f"\nTimestamp: {datetime.now().isoformat()}\n")
          
          # Exit com erro se nenhuma busca funcionou
          if len(all_run_ids) == 0:
              print("\nâŒ All searches failed!")
              exit(1)
          
          print("\nâœ… Workflow completed successfully!")
          EOF

      - name: Upload run info
        uses: actions/upload-artifact@v4
        with:
          name: scraper-run-info-${{ github.run_number }}
          path: last_runs.txt
          retention-days: 30

      - name: Summary
        run: |
          echo "## ðŸŽ¯ LinkedIn Job Scraper - Multiple Searches" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** âœ… Completed" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Searches Executed" >> $GITHUB_STEP_SUMMARY
          echo "1. Senior Frontend Engineer - Madrid" >> $GITHUB_STEP_SUMMARY
          echo "2. React Developer Remote - Spain" >> $GITHUB_STEP_SUMMARY
          echo "3. Staff Engineer - Spain" >> $GITHUB_STEP_SUMMARY
          echo "4. Frontend Lead - Madrid" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— View Results" >> $GITHUB_STEP_SUMMARY
          echo "[Open Apify Console](https://console.apify.com/actors/runs)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ Run IDs" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat last_runs.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY